# Пошаговый план реализации PWA «ithappens»

Ниже — последовательная, многопроходная нарезка проекта: сначала высокоуровневые фазы (Проход 1), затем инкременты, каждый из которых даёт законченную ценность (Проход 2), и, наконец, микроэтапы с чёткими критериями готовности и тестами (Проход 3). После каждого прохода — краткий анализ и корректировки.

---

## Проход 1 — Высокоуровневые фазы (скелет проекта)

1) **F0. Бутстрап репозитория и инфраструктуры**  
   - Инициализация Vite + Preact + TypeScript.  
   - ESLint + Prettier, Vitest + @testing-library/preact.  
   - Taskfile.yml (команды dev/build/test/lint/format/check/docker).  
   - Git hooks (pre-commit → `task check`).  
   - Базовый Dockerfile (multi-stage) + docker-compose + nginx конфиг-заглушка.  
   - CI скелет (GitHub Actions) — линт, тесты, сборка.

2) **F1. Данные и сервисы**  
   - Размещение `src/data/stories.json` (~26 МБ).  
   - `storyService`: загрузка JSON при старте, индексация существующих ID, API: `getById`, `getNextId`, `getPrevId`, `getFirstId`, `getLastId`.  
   - Учет пропусков ID.

3) **F2. Базовый UI/UX и навигация**  
   - Каркас приложения: верхняя панель с ID, область контента, нижняя панель навигации.  
   - Компоненты: `StoryViewer`, `Navigation`, `JumpModal`.  
   - Навигация вперёд/назад/по ID, цикличность, поддержка клавиатуры.  
   - CSS Modules + темы (светлая/тёмная через media query).

4) **F3. Сохранение состояния**  
   - `storageService` для `localStorage` (`ithappens_last_story_id`).  
   - Восстановление последней истории, дефолт — ID 1.

5) **F4. PWA и офлайн**  
   - `manifest.json`, иконки.  
   - `sw.js` с Cache First: статические ассеты + `stories.json`.  
   - Стратегия обновления при смене версии (перекеширование, `skipWaiting`/`clientsClaim`).

6) **F5. Тестирование и качество**  
   - Unit-тесты компонентов/утилит/сервисов (≥80% покрытие).  
   - Тест-сценарии из спецификации.  
   - Лёгкая a11y-проверка фокуса и клавиатуры.  
   - Lighthouse (PWA ≥ 90, Perf ≥ 90 для офлайн).

7) **F6. Производительность и сборка**  
   - Минификация, gzip/brotli на nginx, кеш-заголовки.  
   - Preload критичных ресурсов.  
   - Размещение `stories.json` вне бандла (под `public/`) для долгоживущего кэша.

8) **F7. Контейнеризация и деплой**  
   - Финализация Docker (nginx:alpine, порт 8000).  
   - CI: сборка образа на теге, публикация в GHCR.  
   - Деплой через docker-compose на VPS, reverse proxy на 8000.

**Анализ после Прохода 1:** фазы логичны, но крупноваты для безопасной параллельной реализации. Переходим к инкрементам, где каждый шаг даёт проверяемую ценность.

---

## Проход 2 — Инкременты с ценностью (тонкие вертикальные срезы)

**I0. Walking Skeleton (онлайн, без офлайна, без реальных данных)**  
- Пустой экран с тремя зонами, рендер каркаса Preact, навигационные кнопки (заглушки).  
- Роутинг не нужен (SPA-одностраничник).  
- Тест: приложение монтируется; кнопки существуют; базовый ESLint/Prettier/CI зелёные.  
- DoD: `task dev` работает; `task test` проходит; Docker локально отдаёт статику через nginx-заглушку.

**I1. Встраивание реальных данных (минимальным объёмом)**  
- Добавить `stories.json.sample` с 20 историями.  
- Реализовать `storyService` с загрузкой из `/stories.json.sample`.  
- Навигация вперёд/назад с учётом пропусков ID.  
- Тесты на сервис и утилиты навигации.  
- DoD: клики «Назад/Вперёд» меняют историю; цикличность работает.

**I2. Переход на полный датасет (~26 МБ)**  
- Перенести полноразмерный `stories.json` в `public/`.  
- Ленивая загрузка при старте + индикатор «инициализации» (короткий текст без анимаций).  
- Память: хранение в JS-объекте; проверка GC.  
- DoD: первая история отображается ≤ N секунд после первой загрузки; память стабильна; навигация мгновенная.

**I3. UI завершаем: StoryViewer/Navigation/JumpModal**  
- Рендер ID сверху, текст с сохранением `\n`, вертикальная прокрутка.  
- Модалка: ввод ID, валидация, сообщения об ошибке, закрытие по overlay/esc/кнопке.  
- Клавиатура: ←/→.  
- Темы: светлая/тёмная по системным настройкам (CSS variables).  
- DoD: все пункты раздела 2 спецификации выполнены.

**I4. Сохранение состояния**  
- `storageService`: запись/чтение `ithappens_last_story_id`.  
- Логика первого запуска: ID 1.  
- DoD: при перезапуске открывается последняя история; при первом — ID 1.

**I5. PWA и офлайн (минимально работоспособно)**  
- `manifest.json`, иконки-заглушки.  
- `sw.js`: кэш статических ассетов + `stories.json` (Cache First).  
- DoD: при offline приложение полностью функционально.

**I6. Качество и производительность**  
- Юнит-тесты компонентов, сервисов, утилит (≥80%).  
- nginx: gzip/brotli, кэш для ассетов, корректные MIME.  
- Lighthouse: PWA+Perf ≥ 90.  
- DoD: отчёты прикладываются артефактами CI.

**I7. CI/CD и контейнер**  
- GitHub Actions: push/PR → check; tag → build+push Docker GHCR.  
- Docker multi-stage + nginx конфиг под SPA (fallback на `index.html`).  
- DoD: образ собирается на теге и запускается локально через `docker-compose up -d`.

**I8. Продакшн-деплой**  
- VPS: `docker-compose pull && up -d`.  
- Reverse proxy на порт 8000.  
- Дымовые тесты офлайна на устройстве.  
- DoD: доступно снаружи, офлайн работает, навигация мгновенная.

**Анализ после Прохода 2:** инкременты дают ценность и покрывают риски (данные 26 МБ, офлайн, кэш). Некоторые инкременты ещё довольно крупные (I2, I5, I6). Уточним микроэтапами.

---

## Проход 3 — Микроэтапы (30–90 минут, с тестами и DoD)

### M0. Бутстрап и качество
- **M0.1** Скелет Vite + Preact + TS; стартовая страница.  
  DoD: `npm run dev` открывает пустой экран с текстом.
- **M0.2** ESLint + Prettier + базовые правила; `task lint/format`.  
  DoD: `task check` зелёный.
- **M0.3** Vitest + @testing-library/preact; один пробный тест.  
  DoD: `task test` зелёный, coverage-репорт включен.
- **M0.4** Taskfile.yml (dev/build/test/lint/format/check).  
  DoD: все команды доступны.
- **M0.5** Git hook pre-commit (lefthook/husky) → `task check`.  
  DoD: локальный коммит без ошибок.

### M1. Каркас UI
- **M1.1** Разметка трёх зон (верх/контент/низ), семантические роли.  
  Тест: рендерятся нужные контроли.
- **M1.2** Кнопки «Назад/ID/Вперёд» (без логики), disabled-состояния.  
  Тест: доступность кнопок по `role`.
- **M1.3** CSS Modules: базовая типографика и отступы.  
  DoD: визуально читаемо на мобильных ширинах.

### M2. Мини-датасет и сервис данных
- **M2.1** `stories.json.sample` (20 записей с пропусками).  
- **M2.2** `storyService` (fetch sample, типы, индексация ID).  
  Тесты: `getById`, `getNextId`, `getPrevId`, крайние случаи.
- **M2.3** `navigation.ts`: функции вычисления следующего/предыдущего с цикличностью.  
  Тесты: переходы, пропуски ID.
- **M2.4** Интеграция с UI: кнопки листают истории из sample.  
  Тест: клики меняют текст.

### M3. Полный датасет
- **M3.1** Перенос `stories.json` (~26 МБ) в `public/`.  
- **M3.2** Загрузка при старте + «инициализация…» (plain-text).  
  Тест: рендер плейсхолдера до загрузки.
- **M3.3** Оптимизация парсинга (чтение как текст + `JSON.parse` с try/catch).  
  Тест: обработка ошибки загрузки (показываем сообщение и кнопку «повторить»).

### M4. Завершение UI/UX
- **M4.1** `StoryViewer`: рендер `\n` → `<br/>`; длинные истории прокручиваются.  
  Тест: сохранение переносов.
- **M4.2** `JumpModal`: поле ввода, валидация диапазона и существования ID.  
  Тест: ошибки на несуществующий/пустой ввод, закрытие кликом/ESC.
- **M4.3** Клавиатура: ←/→ слушатели на `window`.  
  Тест: навигация по клавишам.
- **M4.4** Темы: CSS-переменные + `prefers-color-scheme`.  
  Тест: переключение через DevTools симуляцию.

### M5. Состояние
- **M5.1** `storageService`: `getLast`, `setLast` по ключу `ithappens_last_story_id`.  
  Тест: запись/чтение (использовать JSDOM `localStorage`).
- **M5.2** Инициализация: при запуске открыть последнюю, иначе ID 1.  
  Тест: два сценария.

### M6. PWA минимум
- **M6.1** `manifest.json` (из спецификации), подключение в `index.html`.  
  Тест: Lighthouse видит manifest.
- **M6.2** Иконки (192/512, favicon); маскируемая область ≥ 80%.  
  Проверка: devtools application → icons.
- **M6.3** `sw.js`: кэш статиков и `stories.json` (Cache First).  
  Тест: отключить сеть → приложение функционирует полностью.
- **M6.4** Обновление версии: `skipWaiting` + `clientsClaim`; кэш по версии.  
  Тест: смена `CACHE_VERSION` перекаширует ассеты.

### M7. Качество и перф
- **M7.1** Покрытие тестами ≥80% (компоненты/сервисы/утилиты).  
  Тест: отчёт coverage.
- **M7.2** nginx: gzip/brotli, кэш заголовки, SPA fallback.  
  Тест: `curl -I` заголовки; ручная проверка SPA.
- **M7.3** Lighthouse (mobile): PWA ≥90, Perf ≥90 (офлайн).  
  Тест: отчёт в CI-артефактах.

### M8. Контейнер и CI/CD
- **M8.1** Dockerfile (multi-stage Node build → nginx:alpine, порт 8000).  
  Тест: локальный `docker build` и `docker run`.
- **M8.2** docker-compose.yml (порт 8000, restart policy).  
  Тест: `docker-compose up -d` работает.
- **M8.3** GitHub Actions: workflow push/PR → check; tag → build & push GHCR.  
  Тест: тестовый релиз-тег, образ появился в GHCR.

### M9. Деплой и дымовые тесты
- **M9.1** VPS подготовка: docker/docker-compose, reverse proxy на 8000.  
- **M9.2** Деплой: pull образа, `up -d`.  
- **M9.3** Дымовые: онлайн/офлайн, навигация, модалка, восстановление ID.  
  DoD: все сценарии из раздела 10.2 проходят на реальном телефоне.

**Анализ после Прохода 3:** микроэтапы достаточно малы для безопасной реализации с тестированием, и при этом группируются в инкременты, каждый даёт практическую ценность: сначала каркас, затем данные, затем офлайн и, наконец, публикация.

---

## Критерии готовности и артефакты по фичам

- **Навигация**: тесты на переходы/цикличность/клавиатуру/пропуски ID зелёные; ручная проверка на мобильном.  
- **Отображение историй**: переносы строк сохраняются; вертикальная прокрутка; ID отображается.  
- **Сохранение состояния**: после перезапуска открывается последняя история; первый запуск — ID 1.  
- **Модалка**: корректная валидация и UX закрытия.  
- **PWA/офлайн**: app workbox-статус в DevTools «controlled», при offline доступна полная функциональность.  
- **Производительность**: Lighthouse ≥90/90; размер критического бандла минимален; `stories.json` кэшируется отдельно.  
- **CI/CD**: workflow проходит; образ публикуется при теге; docker-compose поднимает сервис.

---

## Риски и меры

- **R1: Объём `stories.json` (~26 МБ) на мобильных**  
  *Мера:* держать файл в `public/`, отдавать с gzip/brotli, настроить долгий кэш, загружать один раз при старте и кэшировать SW. Показать короткий текст «инициализация…».

- **R2: Память на слабых устройствах**  
  *Мера:* в dev замерить потребление, при необходимости — хранить строки в объекте без копий, избегать лишних `useState`/`useMemo` на весь массив. (В рамках спецификации остаёмся с полной загрузкой в память.)

- **R3: Обновление SW/кэша**  
  *Мера:* версионирование кэша, `skipWaiting/clientsClaim`, ручной сценарий: перезапуск приложения при мажорных изменениях.

- **R4: Доступность (клавиатура/фокус/контрасты)**  
  *Мера:* тесты на доступность для модалки и кнопок, контраст по темам.

---

## Каркас файлов/папок (быстрый ориентир)

```
ithappens/
├── src/
│   ├── components/
│   │   ├── StoryViewer.tsx
│   │   ├── StoryViewer.module.css
│   │   ├── Navigation.tsx
│   │   ├── Navigation.module.css
│   │   ├── JumpModal.tsx
│   │   └── JumpModal.module.css
│   ├── services/
│   │   ├── storyService.ts
│   │   └── storageService.ts
│   ├── utils/
│   │   └── navigation.ts
│   ├── types/
│   │   └── story.ts
│   ├── data/
│   │   └── (пусто или sample)
│   ├── app.tsx
│   ├── app.module.css
│   └── main.tsx
├── public/
│   ├── stories.json
│   ├── manifest.json
│   ├── sw.js
│   └── icons/
│       ├── icon-192.png
│       ├── icon-512.png
│       └── favicon.ico
├── tests/
│   ├── components/
│   ├── services/
│   └── utils/
├── docker/
│   ├── Dockerfile
│   └── nginx.conf
├── .github/workflows/ci-cd.yml
├── Taskfile.yml
├── docker-compose.yml
├── vite.config.ts
├── tsconfig.json
├── .eslintrc.json
├── .prettierrc
├── .gitignore
└── package.json
```

---

## Матрица «требование → инкремент → тест» (выборочно)

- **Циклическая навигация** → I1/I3 → тесты `navigation.ts` + E2E-эмуляция кликов.  
- **Переход по ID** → I3 → тесты `JumpModal` (валид/невалид).  
- **Сохранение состояния** → I4 → тесты `storageService` + интеграционный.  
- **Офлайн** → I5 → DevTools offline + unit для SW-реестра.  
- **Темы** → I3 → визуальная проверка + snapshot классов.  
- **Производительность** → I6 → Lighthouse в CI.

---

## Итого (после трёх проходов)

- Этапы **достаточно малы** для безопасной реализации (30–90 минутные блоки) и **достаточно крупны**, чтобы каждый инкремент приносил осязаемую ценность (каркас → данные → полный датасет → офлайн → продакшн).  
- Риски (объём данных, память, кэш) учтены с мерами.  
- Критерии готовности и тесты прилагаются к каждому этапу.  

Готов приступить к детализации любого микроэтапа до уровня псевдокода/шаблонов файлов или подготовить стартовый репозиторий с минимальной реализацией Walking Skeleton.

