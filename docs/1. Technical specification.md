# Техническая спецификация: PWA приложение "ithappens"

## 1. Обзор проекта

### 1.1 Описание

PWA приложение для чтения смешных историй с локальным хранением и офлайн-доступом.

### 1.2 Основные характеристики

- **Название:** ithappens
- **Количество историй:** 13,489
- **Размер данных:** ~26 МБ
- **Формат данных:** JSON
- **Платформа:** PWA для мобильных устройств
- **Офлайн режим:** Полная функциональность без интернета

## 2. Функциональные требования

### 2.1 Навигация

- **Кнопка "Вперед"** - переход к следующей истории
- **Кнопка "Назад"** - переход к предыдущей истории
- **Переход по ID** - модальное окно с полем ввода
- **Циклическая навигация** - после последней истории идет первая
- **Клавиатура** - стрелки влево/вправо для навигации

### 2.2 Отображение историй

- **ID истории** - отображается вверху экрана
- **Текст истории** - основная область контента
- **Форматирование** - сохранение переносов строк (\n)
- **Прокрутка** - вертикальная для длинных историй
- **Переходы** - мгновенные, без анимаций

### 2.3 Сохранение состояния

- **Последняя прочитанная** - запоминается при закрытии
- **Восстановление** - открывается последняя история при запуске
- **Первый запуск** - показывается история с ID 1

### 2.4 Модальное окно перехода по ID

- **Поле ввода** - числовой ID истории
- **Валидация** - проверка существования ID
- **Ошибка** - сообщение при несуществующем ID
- **Закрытие** - кнопка закрытия или клик вне окна

## 3. Технические требования

### 3.1 Стек технологий

- **Язык:** TypeScript
- **UI Framework:** Preact
- **Стилизация:** CSS Modules
- **Сборщик:** Vite
- **Тестирование:** Vitest + @testing-library/preact
- **Линтинг:** ESLint
- **Форматирование:** Prettier
- **Система команд:** Taskfile
- **Контейнеризация:** Docker + nginx
- **CI/CD:** GitHub Actions

### 3.2 Структура данных

#### Формат историй (stories.json):

```json
{
  "1": "Текст первой истории с возможными\nпереносами строк",
  "2": "Текст второй истории",
  "5": "Некоторые ID могут быть пропущены",
  ...
  "13489": "Последняя история"
}
```

### 3.3 Хранение данных

- **Загрузка:** Весь JSON загружается в память при старте
- **Кэширование:** Service Worker для офлайн-доступа
- **Состояние:** localStorage для последней прочитанной истории
- **Формат ключа:** `ithappens_last_story_id`

## 4. Дизайн и UI/UX

### 4.1 Принципы дизайна

- **Стиль:** Минималистичный, классический
- **Фокус:** Удобство чтения
- **Адаптивность:** Оптимизация для мобильных устройств
- **Шрифт:** Фиксированный размер, оптимальный для чтения

### 4.2 Структура экрана

```
┌─────────────────────────┐
│      ID: 1234           │  <- Верхняя панель с ID
├─────────────────────────┤
│                         │
│   Текст истории здесь   │  <- Область контента
│   с возможностью        │     (с прокруткой)
│   вертикальной          │
│   прокрутки для         │
│   длинных историй       │
│                         │
├─────────────────────────┤
│ [Назад] [ID] [Вперед]   │  <- Фиксированная панель
└─────────────────────────┘     навигации внизу
```

### 4.3 Темы оформления

- **Светлая тема:** По умолчанию
- **Темная тема:** Автоматическое переключение по системным настройкам
- **CSS переменные:** Для управления цветами

#### Цветовая схема (CSS переменные):

```css
/* Светлая тема */
--bg-color: #ffffff;
--text-color: #333333;
--button-bg: #f0f0f0;
--button-text: #333333;
--border-color: #e0e0e0;

/* Темная тема */
--bg-color: #1a1a1a;
--text-color: #e0e0e0;
--button-bg: #2a2a2a;
--button-text: #e0e0e0;
--border-color: #404040;
```

## 5. Архитектура приложения

### 5.1 Структура проекта

```
ithappens/
├── src/
│   ├── components/
│   │   ├── StoryViewer.tsx
│   │   ├── StoryViewer.module.css
│   │   ├── Navigation.tsx
│   │   ├── Navigation.module.css
│   │   ├── JumpModal.tsx
│   │   └── JumpModal.module.css
│   ├── services/
│   │   ├── storyService.ts
│   │   └── storageService.ts
│   ├── utils/
│   │   └── navigation.ts
│   ├── types/
│   │   └── story.ts
│   ├── data/
│   │   └── stories.json
│   ├── app.tsx
│   ├── app.module.css
│   └── main.tsx
├── public/
│   ├── manifest.json
│   ├── sw.js
│   └── icons/
│       ├── icon-192.png
│       ├── icon-512.png
│       └── favicon.ico
├── tests/
│   ├── components/
│   ├── services/
│   └── utils/
├── docker/
│   ├── Dockerfile
│   └── nginx.conf
├── .github/
│   └── workflows/
│       └── ci-cd.yml
├── Taskfile.yml
├── docker-compose.yml
├── vite.config.ts
├── tsconfig.json
├── .eslintrc.json
├── .prettierrc
├── .gitignore
└── package.json
```

### 5.2 Модульная архитектура

#### Компоненты:

- **StoryViewer** - отображение текста истории
- **Navigation** - кнопки навигации
- **JumpModal** - модальное окно перехода по ID

#### Сервисы:

- **storyService** - загрузка и управление историями
- **storageService** - работа с localStorage

#### Утилиты:

- **navigation** - логика навигации между историями

## 6. PWA конфигурация

### 6.1 Манифест (manifest.json)

```json
{
  "name": "ithappens",
  "short_name": "ithappens",
  "description": "Смешные истории",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#ffffff",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

### 6.2 Service Worker

- Кэширование всех статических ресурсов
- Стратегия: Cache First
- Обновление при изменении версии

### 6.3 Требования к иконкам

- **icon-192.png** - 192x192px, PNG
- **icon-512.png** - 512x512px, PNG
- **favicon.ico** - 32x32px, ICO
- **Формат:** PNG с прозрачностью или однотонным фоном
- **Safe area:** Важный контент в центре 80% площади (для maskable)

## 7. Система сборки и команды

### 7.1 Taskfile команды

```yaml
dev: # Запуск dev сервера с HMR
build: # Production сборка
test: # Запуск всех тестов
test:watch: # Тесты в watch режиме
lint: # ESLint проверка
format: # Prettier форматирование
format:check: # Проверка форматирования
check: # Все проверки (lint + format:check + test)
docker:build: # Сборка Docker образа
docker:run: # Запуск контейнера локально
```

### 7.2 Git hooks

- **pre-commit:** Запуск `task check` перед коммитом

## 8. Docker конфигурация

### 8.1 Dockerfile

- Multi-stage сборка
- Stage 1: Node.js для сборки приложения
- Stage 2: nginx:alpine для production
- Порт: 8000

### 8.2 docker-compose.yml

```yaml
version: '3.8'
services:
  ithappens:
    build: .
    ports:
      - '8000:8000'
    restart: unless-stopped
```

### 8.3 nginx конфигурация

- Раздача статических файлов
- Правильные MIME types
- Кэширование для assets
- Fallback на index.html для SPA

## 9. CI/CD Pipeline

### 9.1 GitHub Actions Workflow

Триггеры:

- **Push в main:** Запуск тестов и проверок
- **Pull Request:** Запуск тестов и проверок
- **Push тега (v*.*.\*):** Сборка и публикация Docker образа

Шаги:

1. Checkout кода
2. Setup Node.js
3. Установка зависимостей
4. Запуск линтера
5. Запуск тестов
6. Сборка приложения
7. (При теге) Сборка Docker образа
8. (При теге) Публикация в GitHub Container Registry

## 10. Тестирование

### 10.1 Unit тесты

- Компоненты UI (Preact Testing Library)
- Сервисы (storyService, storageService)
- Утилиты навигации
- Покрытие: минимум 80%

### 10.2 Тестовые сценарии

1. Отображение истории по ID
2. Навигация вперед/назад
3. Циклическая навигация
4. Переход по несуществующему ID
5. Сохранение/восстановление состояния
6. Обработка пропущенных ID
7. Модальное окно
8. Клавиатурная навигация

## 11. Оптимизация производительности

### 11.1 Загрузка

- Минификация JS/CSS
- Compression (gzip/brotli)
- Preload критических ресурсов
- Мгновенная загрузка без индикаторов

### 11.2 Runtime

- Мемоизация компонентов где необходимо
- Эффективная работа с большим JSON в памяти
- Отсутствие анимаций для быстрого отклика

### 11.3 PWA

- Service Worker для офлайн работы
- Cache-first стратегия
- Минимальный размер бандла (Preact вместо React)

## 12. Поддержка браузеров

- Chrome Mobile: последние 2 версии
- Safari iOS: последние 2 версии
- Samsung Internet: последние 2 версии
- Firefox Mobile: последние 2 версии

## 13. Развертывание

### 13.1 Требования к VPS

- Docker и Docker Compose установлены
- Порт 8000 доступен для nginx reverse proxy
- Минимум 512MB RAM

### 13.2 Процесс деплоя

1. Push тега в GitHub (например, v1.0.0)
2. GitHub Actions собирает и публикует образ
3. На VPS: pull нового образа из ghcr.io
4. docker-compose up -d для запуска
5. nginx reverse proxy направляет трафик на порт 8000

## 14. Безопасность

- Content Security Policy headers
- Отсутствие внешних зависимостей в runtime
- Все данные локальные
- Нет аналитики или трекинга
- Sanitization пользовательского ввода (ID в модалке)

## 15. Примечания для разработчика

### 15.1 Начало работы

```bash
# Клонирование репозитория
git clone <repository>
cd ithappens

# Установка зависимостей
npm install

# Разработка
task dev

# Запуск тестов
task test

# Сборка для production
task build
```

### 15.2 Важные моменты

1. ID историй - целые числа от 1, некоторые пропущены
2. Навигация должна корректно обрабатывать пропуски
3. Все истории загружаются в память при старте
4. Темная тема через CSS переменные и media query
5. Фиксированные кнопки навигации всегда видны
6. Мгновенные переходы без анимаций

### 15.3 Подготовка stories.json

Файл должен быть размещен в `src/data/stories.json` в указанном формате.

---

**Версия спецификации:** 1.0.0  
**Дата:** 2025
