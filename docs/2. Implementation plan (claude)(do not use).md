# План реализации PWA "ithappens" - Итеративная разработка

## Итерация 1: Высокоуровневые фазы

### Фаза 1: Базовая инфраструктура
- Настройка окружения разработки
- Конфигурация сборки
- Базовая структура проекта

### Фаза 2: Основная функциональность
- Загрузка и отображение историй
- Навигация между историями
- Сохранение состояния

### Фаза 3: PWA и оптимизация
- Service Worker и офлайн режим
- Манифест и установка
- Темная тема

### Фаза 4: Контейнеризация и CI/CD
- Docker конфигурация
- GitHub Actions
- Финальное тестирование

**Анализ:** Слишком крупные фазы, каждая может занять несколько дней. Нужна детализация.

---

## Итерация 2: Разбивка на этапы

### Этап 1: Инициализация проекта
- Создание Vite проекта с Preact и TypeScript
- Настройка ESLint и Prettier
- Базовая структура папок
- Taskfile с основными командами

### Этап 2: Статическое отображение
- Компонент StoryViewer
- Загрузка JSON в память
- Отображение одной истории
- CSS модули и базовые стили

### Этап 3: Навигация
- Компонент Navigation
- Логика переходов вперед/назад
- Обработка пропущенных ID
- Циклическая навигация

### Этап 4: Модальное окно
- Компонент JumpModal
- Валидация ввода
- Переход по ID

### Этап 5: Сохранение состояния
- Service для localStorage
- Запоминание последней истории
- Восстановление при загрузке

### Этап 6: Улучшения UX
- Клавиатурная навигация
- Темная тема
- Оптимизация для мобильных

### Этап 7: PWA функционал
- Манифест
- Service Worker
- Иконки

### Этап 8: Тестирование
- Unit тесты компонентов
- Тесты сервисов
- Интеграционные тесты

### Этап 9: DevOps
- Dockerfile
- docker-compose
- GitHub Actions

**Анализ:** Лучше, но некоторые этапы все еще слишком большие. Этапы 2, 3, 6 можно разбить дальше.

---

## Итерация 3: Детальная разбивка

### Этап 1: Минимальный каркас (2-3 часа)
- `npm create vite` с preact-ts шаблоном
- Удаление демо-кода
- Создание базовых папок (components, services, types, utils)
- Установка зависимостей (vitest, @testing-library/preact)

### Этап 2: Конфигурация инструментов (1-2 часа)
- Настройка ESLint для Preact/TypeScript
- Настройка Prettier
- Создание Taskfile с командами dev, build, lint, format
- Проверка что все команды работают

### Этап 3: Типы и моковые данные (1 час)
- Создание types/story.ts
- Создание мокового stories.json с 5-10 историями для разработки
- TypeScript интерфейсы для всех данных

### Этап 4: Простейшее отображение истории (2-3 часа)
- Компонент StoryViewer (только отображение текста)
- Загрузка JSON напрямую в App.tsx
- Отображение истории с ID 1
- Базовые CSS модули

### Этап 5: Сервис управления историями (2 часа)
- storyService.ts с методами loadStories, getStory, getNextId, getPrevId
- Обработка пропущенных ID
- Unit тесты для сервиса

### Этап 6: Простая навигация (2 часа)
- Компонент Navigation с кнопками
- Подключение к storyService
- Переход вперед/назад
- Стили для кнопок

### Этап 7: Интеграция навигации (1-2 часа)
- Связывание Navigation и StoryViewer через App.tsx
- useState для текущего ID
- Циклическая навигация
- Отображение ID вверху

### Этап 8: Фиксированная панель навигации (1 час)
- CSS для фиксированного позиционирования
- Правильная прокрутка контента
- Адаптивность под мобильные

### Этап 9: Модальное окно - структура (2 часа)
- Компонент JumpModal
- Открытие/закрытие
- Базовая верстка
- Overlay и центрирование

### Этап 10: Модальное окно - функционал (2 часа)
- Поле ввода с валидацией
- Обработка перехода
- Показ ошибок
- Закрытие по Escape и клику вне

### Этап 11: localStorage сервис (1-2 часа)
- storageService.ts
- Методы save/load для последней истории
- Unit тесты
- Обработка ошибок

### Этап 12: Интеграция сохранения состояния (1 час)
- Сохранение при изменении истории
- Загрузка при старте приложения
- Fallback на ID 1

### Этап 13: Клавиатурная навигация (1 час)
- Слушатель keydown событий
- Обработка стрелок влево/вправо
- Тесты для утилиты

### Этап 14: Темная тема - CSS переменные (2 часа)
- Определение CSS переменных для цветов
- Media query для prefers-color-scheme
- Применение во всех компонентах

### Этап 15: Полный набор данных (1 час)
- Подключение реального stories.json
- Проверка производительности
- Оптимизация если нужно

### Этап 16: PWA манифест (1 час)
- Создание manifest.json
- Подключение в index.html
- Подготовка заглушек для иконок

### Этап 17: Service Worker (2-3 часа)
- Базовый Service Worker
- Кэширование статики
- Стратегия cache-first
- Регистрация SW

### Этап 18: Unit тесты компонентов (3 часа)
- Тесты StoryViewer
- Тесты Navigation
- Тесты JumpModal
- Тесты App

### Этап 19: Git hooks (1 час)
- Настройка pre-commit hook
- Запуск task check
- Проверка что все работает

### Этап 20: Dockerfile (2 часа)
- Multi-stage Dockerfile
- nginx конфигурация
- Тестирование локально

### Этап 21: GitHub Actions - тесты (2 часа)
- Workflow для CI
- Запуск на push и PR
- Все проверки

### Этап 22: GitHub Actions - деплой (2 часа)
- Публикация в GHCR при теге
- Секреты и permissions
- Тестирование workflow

### Этап 23: docker-compose (1 час)
- docker-compose.yml
- Документация по запуску
- Финальная проверка

**Анализ:** Хорошая детализация, но можно оптимизировать порядок и группировку для более логичного flow разработки.

---

## Итерация 4: Финальный план с оптимальными этапами

### Фаза A: Базовый фундамент (День 1)

#### A1. Инициализация проекта (30 мин)
- `npm create vite@latest ithappens -- --template preact-ts`
- Очистка демо-кода
- Первый коммит

#### A2. Структура и конфигурация (45 мин)
- Создание структуры папок
- tsconfig.json настройки
- vite.config.ts для CSS модулей
- .gitignore

#### A3. Инструменты разработки (45 мин)
- Установка и настройка ESLint
- Установка и настройка Prettier
- .eslintrc.json и .prettierrc

#### A4. Taskfile (30 мин)
- Установка Task
- Создание Taskfile.yml
- Команды: dev, build, lint, format, check

#### A5. Типы и тестовые данные (30 мин)
- types/story.ts
- Моковый stories-mock.json (10 историй)
- Проверка TypeScript

### Фаза B: Минимальный MVP (День 1-2)

#### B1. Отображение одной истории (1 час)
- StoryViewer компонент (простейший)
- Загрузка и показ истории ID 1
- Базовый CSS модуль
- **Проверка:** История отображается

#### B2. Сервис историй (1.5 часа)
- services/storyService.ts
- Методы: loadStories, getStory
- Обработка несуществующих ID
- **Тест:** Unit тест сервиса

#### B3. Навигация - базовая логика (1 час)
- utils/navigation.ts
- getNextId, getPrevId с учетом пропусков
- **Тест:** Unit тесты навигации

#### B4. Кнопки навигации (1.5 часа)
- components/Navigation.tsx
- Интеграция с App.tsx через useState
- CSS модуль для кнопок
- **Проверка:** Переходы работают

#### B5. Циклическая навигация (30 мин)
- Доработка логики для цикла
- Тестирование на границах
- **Тест:** Проверка перехода с последней на первую

### Фаза C: Полная функциональность (День 2)

#### C1. Фиксированный layout (45 мин)
- CSS для фиксированной навигации
- Правильная область прокрутки
- ID истории вверху
- **Проверка:** Layout работает на мобильном

#### C2. Модальное окно - UI (1 час)
- JumpModal компонент
- Стили и анимация появления
- Overlay
- **Проверка:** Окно открывается/закрывается

#### C3. Модальное окно - логика (1 час)
- Поле ввода и валидация
- Переход по ID
- Сообщения об ошибках
- **Тест:** Проверка валидации

#### C4. Клавиатурная навигация (30 мин)
- useEffect для keydown
- Обработка стрелок
- **Проверка:** Стрелки работают

#### C5. Сохранение состояния (1 час)
- services/storageService.ts
- Интеграция в App.tsx
- **Тест:** Состояние восстанавливается после перезагрузки

### Фаза D: Полировка UI (День 3)

#### D1. CSS переменные (45 мин)
- Определение переменных цветов
- Рефакторинг всех стилей
- **Проверка:** Цвета через переменные

#### D2. Темная тема (45 мин)
- Media query для dark mode
- Переопределение переменных
- **Проверка:** Автопереключение темы

#### D3. Мобильная оптимизация (30 мин)
- Размеры шрифтов
- Touch targets для кнопок
- **Проверка:** Удобно на телефоне

#### D4. Подключение полных данных (30 мин)
- Реальный stories.json
- Проверка производительности
- **Проверка:** 13k историй работают быстро

### Фаза E: PWA превращение (День 3-4)

#### E1. PWA манифест (30 мин)
- public/manifest.json
- Подключение в index.html
- Базовые meta теги
- **Проверка:** Приложение определяется как PWA

#### E2. Иконки (30 мин)
- Размещение placeholder иконок
- Обновление манифеста
- **Проверка:** Иконки отображаются

#### E3. Service Worker - базовый (1 час)
- public/sw.js
- Регистрация в main.tsx
- Базовое кэширование
- **Проверка:** SW активен в DevTools

#### E4. Офлайн функционал (1 час)
- Cache стратегия для всех ресурсов
- Обновление при новой версии
- **Проверка:** Работает без интернета

### Фаза F: Качество кода (День 4)

#### F1. Тесты компонентов (2 часа)
- Vitest конфигурация
- Тесты всех компонентов
- **Метрика:** Coverage > 80%

#### F2. Тесты интеграции (1 час)
- Тест полного флоу навигации
- Тест сохранения/восстановления
- **Проверка:** E2E сценарии проходят

#### F3. Git hooks (30 мин)
- Pre-commit hook
- Запуск проверок
- **Проверка:** Коммит блокируется при ошибках

### Фаза G: Контейнеризация (День 5)

#### G1. Dockerfile (1 час)
- Multi-stage build
- nginx конфигурация
- **Проверка:** docker build успешен

#### G2. Локальное тестирование (30 мин)
- docker run
- Проверка на localhost:8000
- **Проверка:** Приложение работает в контейнере

#### G3. docker-compose (30 мин)
- docker-compose.yml
- Переменные окружения
- **Проверка:** docker-compose up работает

### Фаза H: CI/CD (День 5)

#### H1. GitHub Actions - CI (1 час)
- .github/workflows/ci.yml
- Тесты на push/PR
- **Проверка:** Зеленый pipeline

#### H2. GitHub Actions - CD (1 час)  
- Сборка образа при теге
- Публикация в GHCR
- **Проверка:** Образ публикуется

#### H3. Документация (30 мин)
- README.md
- Инструкции по деплою
- **Проверка:** Документация полная

---

## Финальная оценка этапов

### Характеристики этапов:
- **Размер:** 30 минут - 2 часа (оптимально для фокусировки)
- **Независимость:** Каждый этап дает рабочий результат
- **Тестируемость:** Каждый этап имеет четкий критерий проверки
- **Безопасность:** Откат любого этапа не ломает предыдущие

### Ключевые принципы:
1. **Постепенное наращивание:** От простого отображения к полному PWA
2. **Ранняя проверка:** MVP работает уже к концу первого дня
3. **Изоляция рисков:** Сложные части (SW, Docker) в конце
4. **Частые проверки:** После каждого этапа есть что показать

### Метрики успеха:
- День 1: Работающее приложение с навигацией
- День 2: Полная функциональность
- День 3: PWA с офлайн режимом
- День 4: Протестированный код
- День 5: Готово к деплою

### Риски и митигация:
- **Риск:** Проблемы с большим JSON
  **Митигация:** Тестируем рано (этап D4)
  
- **Риск:** Service Worker сложности
  **Митигация:** Базовая функциональность работает и без SW
  
- **Риск:** Docker проблемы
  **Митигация:** Приложение можно деплоить как статику

## Итоговый вывод

План оптимизирован для:
- **Безопасной разработки:** Маленькие, тестируемые шаги
- **Быстрой обратной связи:** Рабочее приложение с первого дня  
- **Гибкости:** Можно остановиться после любой фазы
- **Качества:** Тесты и проверки встроены в процесс

Каждый этап достаточно мал для реализации за один подход, но достаточно значим для видимого прогресса. Зависимости минимизированы, что позволяет параллелить некоторые задачи при необходимости.